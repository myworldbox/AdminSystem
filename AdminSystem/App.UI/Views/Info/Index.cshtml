@using AdminSystem.Application.Dtos
@using AdminSystem.Domain.Entities
@using static AdminSystem.Domain.Enums
@model PagedResultDto<客戶資料>

@{
    ViewData["Title"] = "Customer List";

    // Current filter values
    var searchTerm = Context.Request.Query["searchTerm"].ToString();
    var area = Context.Request.Query["area"].ToString();
    var sex = Context.Request.Query["sex"].ToString();
    var order = Context.Request.Query["order"].ToString();
    var sort = Context.Request.Query["sort"].ToString();
    int page = int.TryParse(Context.Request.Query["page"], out var p) ? p : 1;
    page = page < 1 ? 1 : page;

    var routeValues = new Dictionary<string, string>
    {
        { "searchTerm", searchTerm },
        { "area", area },
        { "sex", sex },
        { "sort", sort }
    };
}

<div class="card shadow-sm">
    <h4 class="card-header fw-bold text-white" style="background-color: #337ab7;">
        Customer List
    </h4>

    <div class="card-body">
        <!-- Search & Filters -->
        <form asp-action="Index" method="get" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-lg-4 col-md-6">
                    <label class="form-label">Search</label>
                    <input type="text" name="searchTerm" value="@searchTerm" class="form-control"
                           placeholder="Name, HKID, Phone, Email..." />
                </div>
                <div class="col-lg-2 col-md-3">
                    <label class="form-label">Area</label>
                    <select name="area" class="form-select" asp-items="@ViewBag.AddressAreaList">
                        <option value="">All Areas</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3">
                    <label class="form-label">Sex</label>
                    <select name="sex" class="form-select" asp-items="@ViewBag.SexList">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col-lg-4 col-md-12 text-md-end">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a asp-action="Index" class="btn btn-outline-secondary ms-2">Clear</a>
                </div>
            </div>
            <input type="hidden" name="order" value="@order" />
        </form>

        <!-- Summary + Add Button -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <small class="text-muted">
                Showing
                <strong>
                    @(Model.Items.Any() ? ((Model.CurrentPage - 1) * Model.PageSize + 1) : 0)
                    – @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalRecords))
                </strong>
                of <strong>@Model.TotalRecords</strong> records
            </small>
            <a asp-action="Create" asp-controller="Info" class="btn btn-success btn-sm">
                Create
            </a>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>
                            @Html.ActionLink("客戶名稱", "Index", new { sort = "客戶名稱", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("統一編號", "Index", new { sort = "統一編號", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("電話", "Index", new { sort = "電話", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("傳真", "Index", new { sort = "傳真", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("地址", "Index", new { sort = "地址", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("Email", "Index", new { sort = "Email", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th>
                            @Html.ActionLink("客戶分類", "Index", new { sort = "客戶分類", order = ViewBag.Order, search = ViewBag.Search, category = ViewBag.Category }, new { @class = "sortable" })
                        </th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items.Any())
                    {
                        foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>@item.客戶名稱</td>
                                <td>@item.統一編號</td>
                                <td>@item.電話</td>
                                <td>@item.傳真</td>
                                <td>@item.地址</td>
                                <td>@item.Email</td>
                                <td>@item.客戶分類</td>
                                <td class="text-center">
                                    <a asp-action="Details" asp-controller="Info" asp-route-id="@item.Id" class="btn btn-sm btn-outline-dark" title="Details">
                                        Details
                                    </a>
                                    <a asp-action="Edit" asp-controller="Info" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary" title="Edit">
                                        Edit
                                    </a>
                                    <a asp-action="Delete" asp-controller="Info" asp-route-id="@item.Id" class="btn btn-sm btn-outline-danger" title="Delete">
                                        Delete
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">No customer records found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center flex-wrap gap-2">

                    <!-- Previous -->
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-all-route-data="@(new Dictionary<string, string>(routeValues) { ["page"] = (Model.CurrentPage - 1).ToString() })">
                            <span>«</span>
                        </a>
                    </li>

                    @{
                        int offset = 3;
                        int start = Math.Max(1, Model.CurrentPage - offset);
                        int end = Math.Min(Model.TotalPages, Model.CurrentPage + offset);
                        if (end - start + 1 < offset * 2 + 1)
                            start = Math.Max(1, end - offset * 2);
                    }

                    <!-- First page + ellipsis -->
                    @if (start > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="Index" asp-all-route-data="@(new Dictionary<string, string>(routeValues) { ["page"] = "1" })">1</a>
                        </li>
                        @if (start > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }
                    }

                    <!-- Page numbers -->
                    @for (int i = start; i <= end; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-all-route-data="@(new Dictionary<string, string>(routeValues) { ["page"] = i.ToString() })">@i</a>
                        </li>
                    }

                    <!-- Ellipsis + Last page -->
                    @if (end < Model.TotalPages)
                    {
                        @if (end < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link"
                               asp-action="Index"
                               asp-all-route-data="@(new Dictionary<string, string>(routeValues) { ["page"] = Model.TotalPages.ToString() })">@Model.TotalPages</a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-all-route-data="@(new Dictionary<string, string>(routeValues) { ["page"] = (Model.CurrentPage + 1).ToString() })">
                            <span>»</span>
                        </a>
                    </li>

                    <!-- Go to page input -->
                    <li class="page-item d-flex align-items-center ms-3">
                        <span class="text-muted small me-2">Go to</span>
                        <input type="number" id="pageInput" min="1" max="@Model.TotalPages"
                               value="@Model.CurrentPage" class="form-control form-control-sm" style="width:70px;">
                        <button type="button" class="btn btn-outline-primary btn-sm ms-1" onclick="goToPage()">
                            Go
                        </button>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

@section Scripts {
    <script>
    function confirmDelete(id, name) {
        if (confirm(`Are you sure you want to delete customer:\n${name}?\n\nThis action cannot be undone.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("Delete", "Info")/' + encodeURIComponent(id);

            // CSRF token (if you use antiforgery)
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = token.getAttribute('name');
                input.value = token.value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
}